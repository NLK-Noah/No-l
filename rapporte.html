<!DOCTYPE html>
<html>
<head>
<link rel="icon" type="image/png" href="static/naima.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Chango&display=swap" rel="stylesheet">
<title>Le Festin d'Hiver</title>

<!-- CSS -->
<link rel="stylesheet" href="static/rapporte.css">

<style>
    /* Style pour le bouton de notification */
    #notifyButton {
        padding: 10px 15px;
        background-color: #e5b800;
        color: #830303;
        border: none;
        border-radius: 5px;
        font-family: 'Chango', sans-serif;
        cursor: pointer;
        margin-bottom: 10px; /* Espace au-dessus de l'input */
    }

    #notifyButton.hidden {
        display: none;
    }
</style>

</head>
<body>

<a href="menu.html">
    <img id="back" src="static/back.png" class="back" />
</a>

<div class="header-space"></div>

<div id="chat-container">
    <!-- Nouveau bouton de notification ajoutÃ© ici -->
    <button id="notifyButton">Activer les notifications de messages</button>

    <ul id="messages"></ul>

    <div id="input-area">
        <input type="text" id="messageInput" placeholder="Ã‰cris un message...">
        <button id="sendBtn">âž¤</button>
    </div>

</div>

<!-- Script JS -->
<script type="module">
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"; 
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

const firebaseConfig = {
    apiKey: "AIzaSyBVQh_y9U1D5gA7BmCCFJgOlEPlUAogxV8",
    authDomain: "santa-secret-3c1f4.firebaseapp.com",
    projectId: "santa-secret-3c1f4",
    storageBucket: "santa-secret-3c1f4.firebasestorage.app",
    messagingSenderId: "238129661360",
    appId: "1:238129661360:web:d6ccb73539dc67d9f68275"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("timestamp", "asc"));

const messagesList = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const notifyButton = document.getElementById("notifyButton"); // RÃ©cupÃ©ration du bouton

const currentUser = localStorage.getItem("username") || "Inconnu";


// ðŸ”¹ LOGIQUE DE NOTIFICATION ðŸ”¹

function handleNotificationPermission(permission) {
    if (permission === "granted") {
        console.log("Notification permission granted.");
        notifyButton.classList.add('hidden'); // Cache le bouton si acceptÃ©
    } else if (permission === "denied") {
        console.log("Notification permission denied.");
        notifyButton.classList.remove('hidden'); // Laisse le bouton visible si refusÃ©/bloquÃ©
    }
}

// VÃ©rifie l'Ã©tat actuel au chargement de la page
if ("Notification" in window) {
    handleNotificationPermission(Notification.permission);
    
    notifyButton.addEventListener("click", () => {
        Notification.requestPermission().then(handleNotificationPermission);
    });
} else {
    notifyButton.classList.add('hidden'); // Cache le bouton si le navigateur ne supporte pas
}

// Fonction pour afficher une notification d'un nouveau message
function showNewMessageNotification(msgSender, msgContent) {
    // N'envoie pas de notification si c'est l'utilisateur local qui a envoyÃ© le message
    if (msgSender === currentUser) return; 

    if (Notification.permission === "granted") {
        new Notification(`Nouveau message de ${msgSender} !`, {
            body: msgContent,
            icon: "static/naima.png"
        });
    }
}


// ðŸ”¹ AFFICHAGE EN TEMPS RÃ‰EL ðŸ”¹
onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
            const msg = change.doc.data();
            const li = document.createElement("li");
            li.innerHTML = `<strong>${msg.sender}</strong> : ${msg.content}`;
            messagesList.appendChild(li);

            // Affiche la notification pour le nouveau message reÃ§u
            showNewMessageNotification(msg.sender, msg.content);
        }
    });
    // auto scroll aprÃ¨s ajout
    messagesList.scrollTop = messagesList.scrollHeight;
});


// ðŸ”¹ ENVOYER UN MESSAGE ðŸ”¹
sendBtn.addEventListener("click", async () => {
    const content = input.value.trim();

    if (content) {
        await addDoc(messagesRef, {
            sender: currentUser, // Utilise le nom d'utilisateur local
            content: content,
            timestamp: serverTimestamp()
        });
        input.value = "";
    }
});

// Touch ENTER
input.addEventListener("keyup", (e) => {
    if (e.key === "Enter") sendBtn.click();
});
</script>

</body>
</html>
