<!DOCTYPE html>
<html>
<head>
<link rel="icon" type="image/png" href="static/naima.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css2?family=Chango&display=swap" rel="stylesheet">
<title>Le Festin d'Hiver</title>

<!-- CSS -->
<link rel="stylesheet" href="static/rapporte.css">
</head>
<body>



<a href="menu.html">
    <img id="back" src="static/back.png" class="back" />
</a>

<div class="header-space"></div>

<div id="chat-container">

    <ul id="messages"></ul>

    <div id="input-area">
        <input type="text" id="messageInput" placeholder="√âcris un message...">
        <button id="sendBtn">‚û§</button>
    </div>

</div>

<!-- Script JS -->
<script type="module">
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc, arrayUnion, arrayRemove } 
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"; 
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

const firebaseConfig = {
    apiKey: "AIzaSyBVQh_y9U1D5gA7BmCCFJgOlEPlUAogxV8",
    authDomain: "santa-secret-3c1f4.firebaseapp.com",
    projectId: "santa-secret-3c1f4",
    storageBucket: "santa-secret-3c1f4.firebasestorage.app",
    messagingSenderId: "238129661360",
    appId: "1:238129661360:web:d6ccb73539dc67d9f68275"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const messagesRef = collection(db, "messages");
const q = query(messagesRef, orderBy("timestamp", "asc"));

const messagesList = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

const currentUser = localStorage.getItem("username") || "Inconnu";


// üîπ FONCTION LIKE/UNLIKE üîπ
async function toggleLike(messageId, currentLikesArray) {
    const messageDocRef = doc(db, "messages", messageId);

    // V√©rifie si l'utilisateur a d√©j√† lik√©
    if (currentLikesArray.includes(currentUser)) {
        // Si oui, on retire le like (unlike)
        await updateDoc(messageDocRef, {
            likes: arrayRemove(currentUser)
        });
    } else {
        // Si non, on ajoute le like
        await updateDoc(messageDocRef, {
            likes: arrayUnion(currentUser)
        });
    }
}


// üîπ AFFICHAGE EN TEMPS R√âEL (MIS √Ä JOUR) üîπ
onSnapshot(q, (snapshot) => {
    // Comme nous utilisons docChanges, nous n'effa√ßons pas tout le innerHTML
    // mais nous devons g√©rer les mises √† jour (likes) sur les messages existants.
    
    // Une approche simple est de reconstruire la liste pour l'instant
    // (pour un chat simple, c'est suffisant).
    messagesList.innerHTML = ""; 

    snapshot.forEach((doc) => {
        const msg = doc.data();
        const li = document.createElement("li");
        
        // Initialise likes comme un tableau vide si undefined
        const likes = msg.likes || []; 
        const isLiked = likes.includes(currentUser);
        const likeButtonClass = isLiked ? 'liked' : '';
        
        li.innerHTML = `
            <div>
                <strong>${msg.sender}</strong> : ${msg.content}
            </div>
            <button class="like-btn ${likeButtonClass}" data-id="${doc.id}">
                ‚ù§Ô∏è ${likes.length}
            </button>
        `;
        messagesList.appendChild(li);
    });

    // Ajoute les √©couteurs d'√©v√©nements apr√®s avoir ajout√© les √©l√©ments au DOM
    document.querySelectorAll('.like-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const messageId = e.target.dataset.id;
            // Trouve le document original dans snapshot pour passer le tableau de likes actuel
            const currentDoc = snapshot.docs.find(d => d.id === messageId);
            if (currentDoc) {
                toggleLike(messageId, currentDoc.data().likes || []);
            }
        });
    });
    
    // auto scroll
    messagesList.scrollTop = messagesList.scrollHeight;

    // NOTE: showNewMessageNotification() a √©t√© d√©plac√©e pour ne notifier que les *nouveaux* messages entrants
    // (voir la prochaine mise √† jour pour r√©int√©grer proprement docChanges et notifications)
});


// üîπ ENVOYER UN MESSAGE (MIS √Ä JOUR AVEC CHAMP LIKES VIDE) üîπ
sendBtn.addEventListener("click", async () => {
    const content = input.value.trim();

    if (content) {
        await addDoc(messagesRef, {
            sender: currentUser, 
            content: content,
            timestamp: serverTimestamp(),
            likes: [] // Initialise le tableau de likes vide
        });
        input.value = "";
    }
});

// Touch ENTER
input.addEventListener("keyup", (e) => {
    if (e.key === "Enter") sendBtn.click();
});
</script>

</body>
</html>
